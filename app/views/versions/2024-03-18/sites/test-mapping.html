{% extends "../layouts/main.html" %}

<!-- Setting the big main heading at the top of the page -->
{% set pageHeadingTextHTML %}
    Draw site area
{% endset %}

<!-- Text that show in the browser tab. Does NOT need changing -->
{% block pageTitle %}
    {{ pageHeadingTextHTML }}
{% endblock %}



{% block head %}

    {% block meta %}
        <meta charset="utf-8" />
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    {% endblock %}

    {% block stylesheets %}
        {% include "govuk-prototype-kit/includes/stylesheets.njk" %}
        <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css">

        <style>
              .geometry-options {
                display: flex;
                flex-direction: row;
              }

              .geometry-button {
                flex: 1;
                border-style: solid;
                border-width: 1px;
                border-image: none;
              }

              .geometry-button-selected {
                background: #4c4c4c;
                color: #fff;
              }

              .options {
                max-width: 260px;
                width: 100%;
                height: 25px;
              }

            #customText
            {
                position: absolute;
                pointer-events: none;
                width: 180px;
                height: 28px;
                font-size: 18px;
                text-align: center;
                color: white;
                background-color: rgba(0, 0, 0);
                padding: 5px;
                border: 2px solid #000;
                border-radius: 5px;
                display: none;
            }

        </style>
    {% endblock %}

{% endblock %}


{% block bodyStart  %}
    <script src="https://js.arcgis.com/4.29/"></script>

    <script>
        require(
            [
                "esri/config",
                "esri/Map",
                "esri/views/MapView",

                "esri/layers/GraphicsLayer",

                "esri/widgets/Sketch",
                "esri/widgets/Sketch/SketchViewModel",

                "esri/widgets/Zoom",

                "esri/views/interactive/sketch/SketchTooltipOptions"
            ],

            function(esriConfig, Map, MapView, GraphicsLayer, Sketch, SketchViewModel, Zoom)
            {
                esriConfig.apiKey = "AAPKc9a29a2e038e4e6a8083e71935672b6fqFWqxlmDlSJ02j13Zia-Wro8TEwr_6VN8GjaWTk4QDq5RYnPJfev7ax649n4kEB9";

                const map =
                    new Map(
                        {
                            {% if data['satelitemap'] == "true" %}
                                basemap: "arcgis/imagery" // arcgis/light-gray/labels   // arcgis/human-geography   // arcgis/imagery
                            {% else %}
                                basemap: "arcgis/light-gray" // arcgis/light-gray/labels   // arcgis/human-geography   // arcgis/imagery
                            {% endif %}
                        }
                    );

                const view =
                    new MapView(
                        {
                            map: map,
                            ui: {
                                components: ["attribution"]
                            },

                            {% if data['satelitemap'] == "true" %}
                                center: [-2, 52.8], // Longitude, latitude
                                zoom: 6, // Zoom level
                            {% else %}
                                 center: [-1.5, 52.8], // Longitude, latitude
                                 zoom: 5, // Zoom level
                            {% endif %}


                            container: "viewDiv", // Div element
                            constraints:
                            {
                                rotationEnabled: false
                            }
                        }
                    );

                let zoom =
                    new Zoom(
                    {
                        view: view
                    }
                );



                // TOOLTIP TEXT
                view.on("pointer-move", function(event)
                {
                    var customText = document.getElementById("customText");
                    customText.style.display = "block";

                    const myDiv = document.getElementById("viewDiv")


                    var rect = myDiv.getBoundingClientRect();
                    var topleftofmapx = rect.left;
                    var topleftofmapy = rect.top;

                    var x = event.x + topleftofmapx;
                    var y = event.y + topleftofmapy + window.scrollY;

                    customText.style.left = (x - 100) + "px";
                    customText.style.top = (y - 80) + "px";
                });

                view.on("pointer-leave", function(event)
                {
                    var customText = document.getElementById("customText");
                    customText.style.display = "none";
                });



                // add a GraphicsLayer for the sketches and the buffer
                const sketchLayer = new GraphicsLayer();
                //const bufferLayer = new GraphicsLayer();
                view.map.add(sketchLayer);

                // The variable for the type of drawing
                var geometryType = null;

                // use SketchViewModel to draw polygons that are used as a filter
                let sketchGeometry = null;
                const sketchViewModel = new SketchViewModel({
                    layer: sketchLayer,
                    view: view,
                    polylineSymbol: {
                        type: "simple-line",
                        color: 	"#d4351c",
                        width: 6
                    },
                    polygonSymbol: {
                        type: "simple-fill",
                        color: [212, 53, 28, 0.3],
                        outline:
                        {
                            color: 	"#d4351c",
                            width: 8
                        },
                        symbolLayers:
                        [
                            {
                                size: 1000,        // Height of the extrusion in meters
                                material: {color: "blue"}
                            }
                        ]
                    },
                    defaultUpdateOptions:
                    {
                        "enableRotation": false,
                        "enableScaling": false,
                        "enableZ": false,
                        "multipleSelectionEnabled": false,
                        "toggleToolOnClick": false
                    },
                    defaultCreateOptions: { hasZ: false }
                });


                sketchViewModel.on(["create"], (event) =>
                {
                    const eventInfo = event.toolEventInfo;

                    // update the filter every time the user finishes drawing the filtergeometry
                    if (event.state == "complete")
                    {
                        var customText = document.getElementById("customText");
                        customText.style.display = "none";
                    }
                    else if (event.state == "start")
                    {
                        // update the tooltip text
                        var customText = document.getElementById("customText");
                        customText.innerText = "Click to continue drawing";
                        //alert("drawn polygon:");
                    }

                    if (eventInfo && eventInfo.type === "vertex-add")
                    {
                        //alert("drawn polygon: point");
                        const addedPoint = eventInfo.added[0];
                        // alert("points " + eventInfo.type + " " +  addedPoint[0] + " " +  addedPoint[1]);

                        var vertices = eventInfo.vertices[0].vertexIndex ;
                        alert("Number of vertices in the drawn polygon:" +  vertices);
                    }

                });



                sketchViewModel.on(["update"], (event) =>
                {
                    //const eventInfo = event.toolEventInfo;

                    if (event.state == "move")
                    {
                        sketchViewModel.cancel();
                    }
                });


                // draw geometry buttons - use the selected geometry to sktech
                document.getElementById("line-geometry-button").onclick = geometryButtonsClickHandler;
                document.getElementById("polygon-geometry-button").onclick = geometryButtonsClickHandler;
                function geometryButtonsClickHandler(event)
                {
                    geometryType = event.target.value;

                    clearFilter();

                    sketchViewModel.create(geometryType);
                }


                // remove the drawing
                document.getElementById("clearFilter").addEventListener("click", clearFilter);

                function clearFilter()
                {
                    sketchGeometry = null;
                    sketchLayer.removeAll();

                    // Start a new model with the same geometry type
                    sketchViewModel.create(geometryType);

                    var customText = document.getElementById("customText");
                    customText.innerText = "Click to start drawing";
                }


                // Removed the most recent point clicked
                document.getElementById("undoLastPoint").onclick = undolastpoint;
                function undolastpoint()
                {
                    sketchViewModel.undo();
                }


                // Zoom in
                document.getElementById("zoomIn").onclick = zoominmap;
                function zoominmap()
                {
                    zoom.zoomIn();
                }

                // Zoom out
                document.getElementById("zoomOut").onclick = zoomoutmap;
                function zoomoutmap()
                {
                    zoom.zoomOut();
                }



            }
        );
    </script>
{% endblock %}


{% block content %}

    <div class="govuk-grid-row">

        <div class="govuk-grid-column-two-thirds">

            <h1 class="govuk-heading-l">
                {{ pageHeadingTextHTML }}
            </h1>

               <p>
                   <a href="test-mapping?satelitemap=false&">Map</a>
                    or
                   <a href="test-mapping?satelitemap=true&">satellite</a>
               </p>


                <div class="govuk-radios govuk-!-margin-bottom-6" data-module="govuk-radios">
                    <div class="govuk-radios__item">
                        <input class="govuk-radios__input" id="line-geometry-button" name="radio-shape-type" type="radio" value="polyline">
                        <label class="govuk-label govuk-radios__label" for="line-geometry-button">
                            Line
                        </label>
                    </div>
                    <div class="govuk-radios__item">
                        <input class="govuk-radios__input" id="polygon-geometry-button" name="radio-shape-type" type="radio" value="polygon">
                        <label class="govuk-label govuk-radios__label" for="polygon-geometry-button">
                            Shape/Polygon
                        </label>
                    </div>

                </div>

                <!--
                <br />Draw a geometry to filter by:
                <div class="geometry-options">
                    <button
                            class="esri-widget--button esri-icon-polyline geometry-button"
                            id="line-geometry-button"
                            value="polyline"
                            title="Filter by line"
                    ></button>
                    <button
                            class="esri-widget--button esri-icon-polygon geometry-button"
                            id="polygon-geometry-button"
                            value="polygon"
                            title="Filter by polygon"
                    ></button>
                </div>
                -->

            <button type=""
                    class="govuk-button govuk-button--secondary"
                    data-module="govuk-button"
                    id="clearFilter">
                Start over
            </button>

            <button type=""
                    class="govuk-button govuk-button--secondary govuk-!-margin-left-3"
                    data-module="govuk-button"
                    id="undoLastPoint">
                Undo last point
            </button>


            <button type=""
                    class="govuk-button govuk-button--secondary  govuk-!-margin-left-9"
                    data-module="govuk-button"
                    id="zoomIn">
                Zoom in
            </button>


            <button type=""
                    class="govuk-button govuk-button--secondary  govuk-!-margin-left-3"
                    data-module="govuk-button"
                    id="zoomOut">
                Zoom out
            </button>


            <div class="govuk-!-margin-bottom-9" id="viewDiv" style="width: 100%; height: 500px;"></div>

            <div id="customText">Click to start drawing</div>


            {{ govukButton({ text: "Continue" }) }}

        </div>

    </div>


{% endblock %}


