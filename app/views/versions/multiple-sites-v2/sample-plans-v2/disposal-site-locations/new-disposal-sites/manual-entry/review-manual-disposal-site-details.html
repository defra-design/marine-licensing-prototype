{% extends "../../../../layouts/sample-plans.html" %}

{% block beforeContent %}
    {% include "../../../../includes/phase-banner.html" %}
    {{ super() }}
    {% include "../../../../includes/back-link.html" %}
{% endblock %}

{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/button/macro.njk" import govukButton %}

<!-- Set the heading for the page -->
{% set pageHeadingTextHTML %}
Review new disposal site details
{% endset %}

<!-- Text that show in the browser tab. Does NOT need changing -->
{% block pageTitle %}
    {{ pageHeadingTextHTML }} - Get a plan for sediment sample analysis
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <span class="govuk-caption-l">{{ data['sample-plan-project-name-text-input'] }}</span>
        <h1 class="govuk-heading-l">
            {{ pageHeadingTextHTML }}
        </h1>
        
        <!-- Check if all required fields are completed for all sites -->
        {% set siteCount = data['disposal-site-manual-entry-count'] | int %}
        {% if not siteCount or siteCount == 0 %}
            {% set siteCount = 1 %}
        {% endif %}
        
        {% set allComplete = true %}
        
        {% for siteNum in range(1, siteCount + 1) %}
            {# Check site name #}
            {% if not data['new-disposal-site-' + siteNum + '-name'] %}
                {% set allComplete = false %}
            {% endif %}
            
            {# Check coordinate entry method and system #}
            {% if not data['new-disposal-site-' + siteNum + '-coordinate-entry-method'] or 
                not data['new-disposal-site-' + siteNum + '-coordinate-system'] %}
                {% set allComplete = false %}
            {% endif %}
            
            {# Check coordinates based on entry method #}
            {% set entryMethod = data['new-disposal-site-' + siteNum + '-coordinate-entry-method'] %}
            {% if entryMethod == 'Enter one set of coordinates and a width to create a circular site' %}
                {% if not data['new-disposal-site-' + siteNum + '-centre-latitude'] or 
                    not data['new-disposal-site-' + siteNum + '-centre-longitude'] or
                    not data['new-disposal-site-' + siteNum + '-width'] %}
                    {% set allComplete = false %}
                {% endif %}
            {% else %}
                {# Check at least 3 points #}
                {% for i in range(1, 4) %}
                    {% if not data['new-disposal-site-' + siteNum + '-point-' + i + '-latitude'] or 
                        not data['new-disposal-site-' + siteNum + '-point-' + i + '-longitude'] %}
                        {% set allComplete = false %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            {# Check disposal details #}
            {% if not data['new-disposal-details-site-' + siteNum + '-material-type'] or 
                not data['new-disposal-details-site-' + siteNum + '-method'] %}
                {% set allComplete = false %}
            {% endif %}
            
            {# Check maximum volume #}
            {% if not data['new-disposal-site-' + siteNum + '-total-volume'] %}
                {% set allComplete = false %}
            {% endif %}
            
            {# Check beneficial use #}
            {% if not data['new-disposal-site-' + siteNum + '-beneficial-use'] %}
                {% set allComplete = false %}
            {% endif %}
        {% endfor %}
        
        {% if not allComplete %}
            {{ govukInsetText({
                html: "The site details you've provided are saved.<br>You must complete all sections marked <span class='govuk-tag govuk-tag--red govuk-!-margin-bottom-2 govuk-!-margin-top-2'>Incomplete</span> before you can send your information.<br>If you cannot finish now, you can return to this page later."
            }) }}
        {% else %}
            {{ govukInsetText({
                html: "The site details you've provided are saved.<br>You can return to this page and make changes at any time before you send your information."
            }) }}
        {% endif %}
        
        <!-- Providing the new disposal site location section -->
        <div id="site-location" class="govuk-summary-card">
            <div class="govuk-summary-card__title-wrapper">
                <h2 class="govuk-summary-card__title">
                    Providing the new disposal site location
                </h2>
                <ul class="govuk-summary-card__actions">
                    <li class="govuk-summary-card__action">
                        <a class="govuk-link govuk-link--no-visited-state" href="../delete-all-sites">
                            Delete all new disposal site details<span class="govuk-visually-hidden"></span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="govuk-summary-card__content">
                <dl class="govuk-summary-list">
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Method of providing site location
                        </dt>
                        <dd class="govuk-summary-list__value">
                            Enter the coordinates of the site manually
                        </dd>
                    </div>
                </dl>
            </div>
        </div>

        <!-- Loop through each site -->
        {% for siteNum in range(1, siteCount + 1) %}
        
        <!-- Site details section -->
        <div id="site-{{ siteNum }}-details" class="govuk-summary-card">
            <div class="govuk-summary-card__title-wrapper">
                <h2 class="govuk-summary-card__title">
                    New disposal site {{ siteNum }} details
                </h2>
                <ul class="govuk-summary-card__actions">
                    <li class="govuk-summary-card__action">
                        <a class="govuk-link govuk-link--no-visited-state" href="delete-site?site={{ siteNum }}">
                            Delete site<span class="govuk-visually-hidden"> {{ siteNum }}</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="govuk-summary-card__content">
                <dl class="govuk-summary-list govuk-summary-list--full-width">
                    <!-- Site name -->
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Site name
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {{ data['new-disposal-site-' + siteNum + '-name'] or 'Not provided' }}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a href="site-name?site={{ siteNum }}&returnTo=review" class="govuk-link govuk-link--no-visited-state">
                                Change<span class="govuk-visually-hidden"> site name</span>
                            </a>
                        </dd>
                    </div>
                    
                    <!-- Single or multiple sets of coordinates -->
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Single or multiple sets of coordinates
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {% set entryMethod = data['new-disposal-site-' + siteNum + '-coordinate-entry-method'] %}
                            {% if entryMethod == 'Enter one set of coordinates and a width to create a circular site' %}
                                Manually enter one set of coordinates and a width to create a circular site
                            {% elif entryMethod == 'Enter multiple sets of coordinates to mark the boundary of the site' %}
                                Manually enter multiple sets of coordinates to mark the boundary of the site
                            {% else %}
                                <span class="govuk-tag govuk-tag--red">Incomplete</span>
                            {% endif %}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a href="how-do-you-want-to-enter-coordinates?site={{ siteNum }}&returnTo=review&clearData=true" class="govuk-link govuk-link--no-visited-state">
                                Change<span class="govuk-visually-hidden"> single or multiple sets of coordinates</span>
                            </a>
                        </dd>
                    </div>
                    
                    <!-- Coordinate system -->
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Coordinate system
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {% set coordinateSystem = data['new-disposal-site-' + siteNum + '-coordinate-system'] %}
                            {% if coordinateSystem == 'WGS84 (World Geodetic System 1984)' %}
                                WGS84 (World Geodetic System 1984)<br>Latitude and longitude
                            {% elif coordinateSystem == 'British National Grid (OSGB36)' %}
                                British National Grid (OSGB36)<br>Eastings and Northings
                            {% else %}
                                <span class="govuk-tag govuk-tag--red">Incomplete</span>
                            {% endif %}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a href="which-coordinate-system?site={{ siteNum }}&returnTo=review&clearData=true" class="govuk-link govuk-link--no-visited-state">
                                Change<span class="govuk-visually-hidden"> coordinate system</span>
                            </a>
                        </dd>
                    </div>
                    
                    <!-- Coordinates - different display based on entry method -->
                    {% if entryMethod == 'Enter one set of coordinates and a width to create a circular site' %}
                        <!-- Circular site coordinates -->
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                Coordinates at centre site
                            </dt>
                            <dd class="govuk-summary-list__value">
                                {% set centreLat = data['new-disposal-site-' + siteNum + '-centre-latitude'] %}
                                {% set centreLong = data['new-disposal-site-' + siteNum + '-centre-longitude'] %}
                                {% if centreLat and centreLong %}
                                    {{ centreLat }}, {{ centreLong }}
                                {% else %}
                                    <span class="govuk-tag govuk-tag--red">Incomplete</span>
                                {% endif %}
                            </dd>
                            <dd class="govuk-summary-list__actions">
                                <a href="enter-coordinates?site={{ siteNum }}&returnTo=review" class="govuk-link govuk-link--no-visited-state">
                                    Change<span class="govuk-visually-hidden"> coordinates at centre site</span>
                                </a>
                            </dd>
                        </div>
                        
                        <div class="govuk-summary-list__row">
                            <dt class="govuk-summary-list__key">
                                Width of circular site
                            </dt>
                            <dd class="govuk-summary-list__value">
                                {% set width = data['new-disposal-site-' + siteNum + '-width'] %}
                                {% if width %}
                                    {{ width }} metres
                                {% else %}
                                    <span class="govuk-tag govuk-tag--red">Incomplete</span>
                                {% endif %}
                            </dd>
                            <dd class="govuk-summary-list__actions">
                                <a href="site-width?site={{ siteNum }}&returnTo=review" class="govuk-link govuk-link--no-visited-state">
                                    Change<span class="govuk-visually-hidden"> width of circular site</span>
                                </a>
                            </dd>
                        </div>
                        
                    {% elif entryMethod == 'Enter multiple sets of coordinates to mark the boundary of the site' %}
                        <!-- Polygon site coordinates -->
                        {# Find the last point with data #}
                        {% set lastPointNum = 0 %}
                        {% for i in range(1, 6) %}
                            {% if data['new-disposal-site-' + siteNum + '-point-' + i + '-latitude'] and data['new-disposal-site-' + siteNum + '-point-' + i + '-longitude'] %}
                                {% set lastPointNum = i %}
                            {% endif %}
                        {% endfor %}
                        
                        {% for pointNum in range(1, 6) %}
                            {% set pointLat = data['new-disposal-site-' + siteNum + '-point-' + pointNum + '-latitude'] %}
                            {% set pointLong = data['new-disposal-site-' + siteNum + '-point-' + pointNum + '-longitude'] %}
                            
                            {% if pointLat and pointLong %}
                                <div class="govuk-summary-list__row {% if pointNum < lastPointNum %}govuk-summary-list__row--no-border{% endif %}">
                                    <dt class="govuk-summary-list__key">
                                        {% if pointNum == 1 %}
                                        Start and end points
                                        {% else %}
                                        Point {{ pointNum }}
                                        {% endif %}
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        {{ pointLat }}, {{ pointLong }}
                                    </dd>
                                    {% if pointNum == 1 %}
                                    <dd class="govuk-summary-list__actions">
                                        <a href="enter-multiple-coordinates?site={{ siteNum }}&returnTo=review" class="govuk-link govuk-link--no-visited-state">
                                            Change<span class="govuk-visually-hidden"> coordinates</span>
                                        </a>
                                    </dd>
                                    {% else %}
                                    <dd class="govuk-summary-list__actions">
                                        <!-- No separate change link for individual points -->
                                    </dd>
                                    {% endif %}
                                </div>
                            {% elif pointNum <= 3 %}
                                <!-- First 3 points are required -->
                                <div class="govuk-summary-list__row {% if pointNum < 3 %}govuk-summary-list__row--no-border{% endif %}">
                                    <dt class="govuk-summary-list__key">
                                        {% if pointNum == 1 %}
                                        Start and end points
                                        {% else %}
                                        Point {{ pointNum }}
                                        {% endif %}
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        <span class="govuk-tag govuk-tag--red">Incomplete</span>
                                    </dd>
                                    {% if pointNum == 1 %}
                                    <dd class="govuk-summary-list__actions">
                                        <a href="enter-multiple-coordinates?site={{ siteNum }}&returnTo=review" class="govuk-link govuk-link--no-visited-state">
                                            Add<span class="govuk-visually-hidden"> coordinates</span>
                                        </a>
                                    </dd>
                                    {% else %}
                                    <dd class="govuk-summary-list__actions">
                                        <!-- No separate add link for individual points -->
                                    </dd>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Map view -->
                    <div class="govuk-summary-list__row govuk-summary-list__row--no-actions">
                        <dt class="govuk-summary-list__key govuk-summary-list__key--full-width map-label">
                            Map view
                        </dt>
                        <dd class="govuk-summary-list__value govuk-summary-list__value--full-width">
                            {% if entryMethod == 'Enter one set of coordinates and a width to create a circular site' %}
                                <img src="/public/images/map-circle.jpg" alt="Map showing new disposal site {{ siteNum }} as circular area" />
                            {% else %}
                                {# Show map based on number of points #}
                                {% set pointCount = 0 %}
                                {% for i in range(1, 6) %}
                                    {% if data['new-disposal-site-' + siteNum + '-point-' + i + '-latitude'] %}
                                        {% set pointCount = pointCount + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {% if pointCount == 3 %}
                                    <img src="/public/images/map-3-points.jpg" alt="Map showing new disposal site {{ siteNum }} with 3 coordinate points" />
                                {% elif pointCount == 4 %}
                                    <img src="/public/images/map-4-points.jpg" alt="Map showing new disposal site {{ siteNum }} with 4 coordinate points" />
                                {% elif pointCount == 5 %}
                                    <img src="/public/images/map-5-points.jpg" alt="Map showing new disposal site {{ siteNum }} with 5 coordinate points" />
                                {% else %}
                                    <img src="/public/images/map-drawn.jpg" alt="Map showing new disposal site {{ siteNum }}" />
                                {% endif %}
                            {% endif %}
                        </dd>
                    </div>

                    <!-- Type of material being disposed -->
                    <div class="govuk-summary-list__row govuk-summary-list__row--no-border">
                        <dt class="govuk-summary-list__key">
                            Type of material being disposed
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {% if data['new-disposal-details-site-' + siteNum + '-material-type'] %}
                                {% set materialTypes = [] %}
                                {% for type in data['new-disposal-details-site-' + siteNum + '-material-type'] %}
                                    {% if type == 'capital-dredged-material' %}
                                        {% set materialTypes = (materialTypes.push('Capital dredged material'), materialTypes) %}
                                    {% elif type == 'maintenance-dredged-material' %}
                                        {% set materialTypes = (materialTypes.push('Maintenance dredged material'), materialTypes) %}
                                    {% elif type == 'non-dredged-sediments' %}
                                        {% set materialTypes = (materialTypes.push('Non-dredged sediments'), materialTypes) %}
                                    {% elif type == 'organic-material' %}
                                        {% set materialTypes = (materialTypes.push('Organic material of natural origin (for example, seaweed)'), materialTypes) %}
                                    {% elif type == 'other' and data['new-disposal-details-site-' + siteNum + '-material-type-other'] %}
                                        {% set materialTypes = (materialTypes.push('Other: ' + data['new-disposal-details-site-' + siteNum + '-material-type-other']), materialTypes) %}
                                    {% endif %}
                                {% endfor %}
                                {{ materialTypes | join('<br>') | safe if materialTypes.length > 0 else 'Not provided' }}
                            {% else %}
                                <span class="govuk-tag govuk-tag--red">Incomplete</span>
                            {% endif %}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a href="../new-disposal-details-site-{{ siteNum }}" class="govuk-link govuk-link--no-visited-state">
                                {% if data['new-disposal-details-site-' + siteNum + '-material-type'] %}Change{% else %}Add{% endif %}<span class="govuk-visually-hidden"> type of material being disposed</span>
                            </a>
                        </dd>
                    </div>

                    <!-- Proposed method of disposal -->
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Proposed method of disposal
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {% if data['new-disposal-details-site-' + siteNum + '-method'] %}
                                {% set methods = [] %}
                                {% for method in data['new-disposal-details-site-' + siteNum + '-method'] %}
                                    {% if method == 'backhoe-dredger' %}
                                        {% set methods = (methods.push('Backhoe dredger'), methods) %}
                                    {% elif method == 'bottom-dumping-hopper' %}
                                        {% set methods = (methods.push('Bottom dumping (hopper)'), methods) %}
                                    {% elif method == 'direct-pumping-trailing-suction' %}
                                        {% set methods = (methods.push('Direct pumping from trailing suction hopper dredger'), methods) %}
                                    {% elif method == 'pump-out-floating-pipeline' %}
                                        {% set methods = (methods.push('Pump-out via floating pipeline'), methods) %}
                                    {% elif method == 'rainbowing' %}
                                        {% set methods = (methods.push('Rainbowing'), methods) %}
                                    {% elif method == 'split-hopper-barge' %}
                                        {% set methods = (methods.push('Split hopper barge'), methods) %}
                                    {% elif method == 'side-casting' %}
                                        {% set methods = (methods.push('Side casting'), methods) %}
                                    {% elif method == 'other' and data['new-disposal-details-site-' + siteNum + '-method-other'] %}
                                        {% set methods = (methods.push('Other: ' + data['new-disposal-details-site-' + siteNum + '-method-other']), methods) %}
                                    {% endif %}
                                {% endfor %}
                                {{ methods | join('<br>') | safe if methods.length > 0 else 'Not provided' }}
                            {% else %}
                                <span class="govuk-tag govuk-tag--red">Incomplete</span>
                            {% endif %}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a href="../new-disposal-details-site-{{ siteNum }}" class="govuk-link govuk-link--no-visited-state govuk-visually-hidden">
                                {% if data['new-disposal-details-site-' + siteNum + '-method'] %}Change{% else %}Add{% endif %} proposed method of disposal
                            </a>
                        </dd>
                    </div>

                    <!-- Maximum disposal volume -->
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Maximum proposed disposal volume
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {% if data['new-disposal-site-' + siteNum + '-total-volume'] %}
                                {{ data['new-disposal-site-' + siteNum + '-total-volume'] | addCommas }} cubic metres, total volume over the full licence period
                            {% else %}
                                <span class="govuk-tag govuk-tag--red">Incomplete</span>
                            {% endif %}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a href="../new-maximum-disposal-volume{% if siteNum == 2 %}-site-2{% endif %}" class="govuk-link govuk-link--no-visited-state">
                                {% if data['new-disposal-site-' + siteNum + '-total-volume'] %}Change{% else %}Add{% endif %}<span class="govuk-visually-hidden"> maximum proposed disposal volume</span>
                            </a>
                        </dd>
                    </div>

                    <!-- Beneficial use -->
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Beneficial use
                        </dt>
                        <dd class="govuk-summary-list__value">
                            {% if data['new-disposal-site-' + siteNum + '-beneficial-use'] %}
                                {% if data['new-disposal-site-' + siteNum + '-beneficial-use'] == 'yes' %}
                                    Yes: {{ data['new-disposal-site-' + siteNum + '-beneficial-use-description'] }}
                                {% else %}
                                    No
                                {% endif %}
                            {% else %}
                                <span class="govuk-tag govuk-tag--red">Incomplete</span>
                            {% endif %}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            <a href="../new-beneficial-use{% if siteNum == 2 %}-site-2{% endif %}" class="govuk-link govuk-link--no-visited-state">
                                {% if data['new-disposal-site-' + siteNum + '-beneficial-use'] %}Change{% else %}Add{% endif %}<span class="govuk-visually-hidden"> beneficial use</span>
                            </a>
                        </dd>
                    </div>
                </dl>
            </div>
        </div>
        
        {% endfor %}

        <!-- Add another new disposal site button (always visible, disabled when count >= 2) -->
        <div class="govuk-button-group govuk-!-margin-bottom-6">
            {% if siteCount >= 2 %}
            <a role="button" draggable="false" class="govuk-button govuk-button--secondary govuk-button--disabled" style="text-decoration: none;" aria-disabled="true" data-module="govuk-button">
                Add another new disposal site
            </a>
            {% else %}
            <a href="site-name?site={{ siteCount + 1 }}" role="button" draggable="false" class="govuk-button govuk-button--secondary" data-module="govuk-button">
                Add another new disposal site
            </a>
            {% endif %}
        </div>

        <form action="review-manual-disposal-site-details-router" method="post" novalidate>
            <div class="govuk-button-group">
                {{ govukButton({
                    text: "Continue"
                }) }}
            </div>
        </form>
    </div>
</div>

{% endblock %}

