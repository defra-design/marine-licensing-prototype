// Generated by Copilot

module.exports = function (router) {
    let version = "versions/multiple-sites-v2/";
    let section = "exemption/";

//////////////////////////////////////////////////////////////////////////////////////////////
// Manual Entry Flow Routes
//////////////////////////////////////////////////////////////////////////////////////////////

// Does your project involve more than one site? - GET route
router.get('/' + version + section + 'manual-entry/does-your-project-involve-more-than-one-site', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    res.render(version + section + 'manual-entry/does-your-project-involve-more-than-one-site');
});

// Does your project involve more than one site? - POST route
router.post('/' + version + section + 'manual-entry/does-your-project-involve-more-than-one-site-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";

    const selection = req.session.data['manual-multiple-sites'];

    if (!selection) {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
        res.redirect('does-your-project-involve-more-than-one-site');
        return;
    }

    // Route based on selection
    switch(selection) {
        case "Yes":
            res.redirect('site-name');
            break;
        case "No":
            res.redirect('../stop');
            break;
        default:
            res.redirect('does-your-project-involve-more-than-one-site');
    }
});

// Site name - GET route
router.get('/' + version + section + 'manual-entry/site-name', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/site-name');
});

// Site name - POST route
router.post('/' + version + section + 'manual-entry/site-name-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";

    const siteName = req.session.data['manual-site-name-text-input'];
    const returnTo = req.query.returnTo;

    if (!siteName || siteName.trim() === "") {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
        res.redirect('site-name' + (returnTo ? '?returnTo=' + returnTo : ''));
        return;
    }

    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    res.redirect('same-activity-dates');
});

// Are the activity dates the same for every site? - GET route
router.get('/' + version + section + 'manual-entry/same-activity-dates', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/same-activity-dates');
});

// Are the activity dates the same for every site? - POST route
router.post('/' + version + section + 'manual-entry/same-activity-dates-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";

    const selection = req.session.data['manual-same-activity-dates'];
    const returnTo = req.query.returnTo;

    if (!selection) {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
        res.redirect('same-activity-dates' + (returnTo ? '?returnTo=' + returnTo : ''));
        return;
    }

    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    // Route based on selection
    switch(selection) {
        case "Yes":
            res.redirect('activity-dates');
            break;
        case "No":
            res.redirect('individual-site-activity-dates');
            break;
        default:
            res.redirect('same-activity-dates');
    }
});

// Individual site activity dates - GET route
router.get('/' + version + section + 'manual-entry/individual-site-activity-dates', function (req, res) {
    req.session.data['startdateerror'] = "false";
    req.session.data['enddateerror'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/individual-site-activity-dates');
});

// Individual site activity dates - POST route
router.post('/' + version + section + 'manual-entry/individual-site-activity-dates-router', function (req, res) {
    req.session.data['startdateerror'] = "false";
    req.session.data['enddateerror'] = "false";

    const startDay = req.session.data['manual-start-date-date-input-day'];
    const startMonth = req.session.data['manual-start-date-date-input-month'];
    const startYear = req.session.data['manual-start-date-date-input-year'];

    const endDay = req.session.data['manual-end-date-date-input-day'];
    const endMonth = req.session.data['manual-end-date-date-input-month'];
    const endYear = req.session.data['manual-end-date-date-input-year'];
    
    const returnTo = req.query.returnTo;

    if (!startDay || !startMonth || !startYear) {
        req.session.data['startdateerror'] = "true";
    }

    if (!endDay || !endMonth || !endYear) {
        req.session.data['enddateerror'] = "true";
    }

    if (req.session.data['startdateerror'] === "true" || req.session.data['enddateerror'] === "true") {
        return res.redirect('individual-site-activity-dates' + (returnTo ? '?returnTo=' + returnTo : ''));
    }

    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    res.redirect('same-activity-description');
});

// Activity dates - GET route
router.get('/' + version + section + 'manual-entry/activity-dates', function (req, res) {
    req.session.data['startdateerror'] = "false";
    req.session.data['enddateerror'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/activity-dates');
});

// Activity dates - POST route
router.post('/' + version + section + 'manual-entry/activity-dates-router', function (req, res) {
    req.session.data['startdateerror'] = "false";
    req.session.data['enddateerror'] = "false";

    const startDay = req.session.data['manual-start-date-date-input-day'];
    const startMonth = req.session.data['manual-start-date-date-input-month'];
    const startYear = req.session.data['manual-start-date-date-input-year'];

    const endDay = req.session.data['manual-end-date-date-input-day'];
    const endMonth = req.session.data['manual-end-date-date-input-month'];
    const endYear = req.session.data['manual-end-date-date-input-year'];
    
    const returnTo = req.query.returnTo;

    if (!startDay || !startMonth || !startYear) {
        req.session.data['startdateerror'] = "true";
    }

    if (!endDay || !endMonth || !endYear) {
        req.session.data['enddateerror'] = "true";
    }

    if (req.session.data['startdateerror'] === "true" || req.session.data['enddateerror'] === "true") {
        return res.redirect('activity-dates' + (returnTo ? '?returnTo=' + returnTo : ''));
    }

    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    res.redirect('same-activity-description');
});

// Is the activity description the same for every site? - GET route
router.get('/' + version + section + 'manual-entry/same-activity-description', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/same-activity-description');
});

// Is the activity description the same for every site? - POST route
router.post('/' + version + section + 'manual-entry/same-activity-description-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";

    const selection = req.session.data['manual-same-activity-description'];
    const returnTo = req.query.returnTo;

    if (!selection) {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
        res.redirect('same-activity-description' + (returnTo ? '?returnTo=' + returnTo : ''));
        return;
    }

    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    // Route based on selection
    switch(selection) {
        case "Yes":
            res.redirect('activity-description');
            break;
        case "No":
            res.redirect('individual-site-activity-description');
            break;
        default:
            res.redirect('same-activity-description');
    }
});

// Individual site activity description - GET route
router.get('/' + version + section + 'manual-entry/individual-site-activity-description', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/individual-site-activity-description');
});

// Individual site activity description - POST route
router.post('/' + version + section + 'manual-entry/individual-site-activity-description-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";

    const description = req.session.data['manual-individual-activity-details-text-area'];
    const returnTo = req.query.returnTo;

    if (!description || description.trim() === "") {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
        res.redirect('individual-site-activity-description' + (returnTo ? '?returnTo=' + returnTo : ''));
        return;
    }

    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    res.redirect('how-do-you-want-to-enter-the-coordinates');
});

// Activity description - GET route
router.get('/' + version + section + 'manual-entry/activity-description', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/activity-description');
});

// Activity description - POST route
router.post('/' + version + section + 'manual-entry/activity-description-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";

    const description = req.session.data['manual-activity-details-text-area'];
    const returnTo = req.query.returnTo;

    if (!description || description.trim() === "") {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
        res.redirect('activity-description' + (returnTo ? '?returnTo=' + returnTo : ''));
        return;
    }

    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    res.redirect('how-do-you-want-to-enter-the-coordinates');
});

// How do you want to enter the coordinates? - GET route
router.get('/' + version + section + 'manual-entry/how-do-you-want-to-enter-the-coordinates', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/how-do-you-want-to-enter-the-coordinates');
});

// How do you want to enter the coordinates? - POST route
router.post('/' + version + section + 'manual-entry/how-do-you-want-to-enter-the-coordinates-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";

    const selection = req.session.data['manual-coordinate-entry-method'];
    const clearSubsequent = req.query.clearSubsequent;
    const returnTo = req.query.returnTo;

    if (!selection) {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
        res.redirect('how-do-you-want-to-enter-the-coordinates' + (returnTo ? '?returnTo=' + returnTo : ''));
        return;
    }

    // If clearSubsequent is true OR returning from review, clear coordinate-related data
    if (clearSubsequent === 'true' || req.session.data['fromReviewSiteDetails'] === 'true') {
        // Clear coordinate system
        req.session.data['manual-coordinate-system-radios'] = '';
        
        // Clear coordinate data
        req.session.data['manual-latitude'] = '';
        req.session.data['manual-longitude'] = '';
        req.session.data['manual-site-width'] = '';
        
        // Clear multiple coordinates
        for (let i = 1; i <= 5; i++) {
            req.session.data[`manual-coordinates-point-${i}-latitude`] = '';
            req.session.data[`manual-coordinates-point-${i}-longitude`] = '';
        }
    }

    // Clear the fromReviewSiteDetails flag if it was set
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails'];
    }

    // Route based on selection
    switch(selection) {
        case "Enter one set of coordinates and a width to create a circular site":
            res.redirect('which-coordinate-system');
            break;
        case "Enter multiple sets of coordinates to mark the boundary of the site":
            res.redirect('which-coordinate-system');
            break;
        default:
            res.redirect('how-do-you-want-to-enter-the-coordinates');
    }
});

// Which coordinate system? - GET route
router.get('/' + version + section + 'manual-entry/which-coordinate-system', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/which-coordinate-system');
});

// Which coordinate system? - POST route
router.post('/' + version + section + 'manual-entry/which-coordinate-system-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";

    const selection = req.session.data['manual-coordinate-system-radios'];
    const coordinateMethod = req.session.data['manual-coordinate-entry-method'];
    const clearCoordinates = req.query.clearCoordinates;
    const returnTo = req.query.returnTo;

    if (!selection) {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
        res.redirect('which-coordinate-system' + (returnTo ? '?returnTo=' + returnTo : ''));
        return;
    }

    // If clearCoordinates is true OR returning from review, clear coordinate data but keep the system selection
    if (clearCoordinates === 'true' || req.session.data['fromReviewSiteDetails'] === 'true') {
        // Clear coordinate data
        req.session.data['manual-latitude'] = '';
        req.session.data['manual-longitude'] = '';
        req.session.data['manual-site-width'] = '';
        
        // Clear multiple coordinates
        for (let i = 1; i <= 5; i++) {
            req.session.data[`manual-coordinates-point-${i}-latitude`] = '';
            req.session.data[`manual-coordinates-point-${i}-longitude`] = '';
        }
    }

    // Clear the fromReviewSiteDetails flag if it was set
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails'];
    }

    // Route based on coordinate entry method
    if (coordinateMethod === "Enter multiple sets of coordinates to mark the boundary of the site") {
        res.redirect('enter-multiple-coordinates');
    } else {
        // For circular sites
        res.redirect('enter-coordinates');
    }
});

// Enter multiple coordinates - GET route
router.get('/' + version + section + 'manual-entry/enter-multiple-coordinates', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/enter-multiple-coordinates');
});

// Enter multiple coordinates - POST route
router.post('/' + version + section + 'manual-entry/enter-multiple-coordinates-router', function (req, res) {
    // Reset global error states
    req.session.data['errorthispage'] = "false";
    req.session.data['errors'] = [];

    // Get the selected coordinate system
    const system = req.session.data['manual-coordinate-system-radios'];
    const usingOSGB36 = system === "OSGB36 (National Grid)";
    const latLabel = usingOSGB36 ? "Eastings" : "Latitude";
    const longLabel = usingOSGB36 ? "Northings" : "Longitude";
    const returnTo = req.query.returnTo;

    // Loop over points 1-5
    for (let i = 1; i <= 5; i++) {
        const latKey = `manual-coordinates-point-${i}-latitude`;
        const longKey = `manual-coordinates-point-${i}-longitude`;
        const latVal = req.session.data[latKey];
        const longVal = req.session.data[longKey];

        const latMissing = !latVal || latVal.trim() === "";
        const longMissing = !longVal || longVal.trim() === "";

        const pointLabel = i === 1 ? "start and end point" : `point ${i}`;

        // Check visibility for Points 4 & 5 based on flags
        const isPointVisible = i <= 3 || req.session.data[`manual-coordinates-visible-point-${i}`] === "true";

        // Skip validation for hidden points with no entered data
        if (!isPointVisible && (latMissing && longMissing)) {
            req.session.data[`error-${latKey}`] = "false";
            req.session.data[`error-${longKey}`] = "false";
            continue;
        }

        // If lat or long is missing, mark as an error
        if (latMissing || longMissing) {
            req.session.data['errorthispage'] = "true";
        }

        // Latitude error handling
        if (latMissing) {
            req.session.data[`error-${latKey}`] = "true";
            req.session.data['errors'].push({
                text: `Enter the ${latLabel.toLowerCase()} of ${pointLabel}`,
                anchor: `${latKey}`
            });
        } else {
            req.session.data[`error-${latKey}`] = "false";
        }

        // Longitude error handling
        if (longMissing) {
            req.session.data[`error-${longKey}`] = "true";
            req.session.data['errors'].push({
                text: `Enter the ${longLabel.toLowerCase()} of ${pointLabel}`,
                anchor: `${longKey}`
            });
        } else {
            req.session.data[`error-${longKey}`] = "false";
        }
    }

    // Copy manual coordinates to the coordinates data structure for display
    for (let i = 1; i <= 5; i++) {
        const manualLat = req.session.data[`manual-coordinates-point-${i}-latitude`];
        const manualLong = req.session.data[`manual-coordinates-point-${i}-longitude`];
        
        if (manualLat) {
            req.session.data[`manual-coordinates-point-${i}-latitude`] = manualLat;
        }
        if (manualLong) {
            req.session.data[`manual-coordinates-point-${i}-longitude`] = manualLong;
        }
    }

    // Redirect to the current page if there are errors, else continue to the next page
    if (req.session.data['errorthispage'] === "true") {
        return res.redirect('enter-multiple-coordinates' + (returnTo ? '?returnTo=' + returnTo : ''));
    }

    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    // Redirect to review page
    res.redirect('review-site-details');
});

// Enter coordinates - GET route
router.get('/' + version + section + 'manual-entry/enter-coordinates', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errortypetwo'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/enter-coordinates');
});

// Enter coordinates - POST route
router.post('/' + version + section + 'manual-entry/enter-coordinates-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errortypetwo'] = "false";

    const latitude = req.session.data['manual-latitude'];
    const longitude = req.session.data['manual-longitude'];
    const returnTo = req.query.returnTo;

    if (!latitude || latitude.trim() === "") {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
    }

    if (!longitude || longitude.trim() === "") {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypetwo'] = "true";
    }

    if (req.session.data['errorthispage'] === "true") {
        res.redirect('enter-coordinates' + (returnTo ? '?returnTo=' + returnTo : ''));
        return;
    }

    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    res.redirect('site-width');
});

// Site width - GET route
router.get('/' + version + section + 'manual-entry/site-width', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    req.session.data['errors'] = [];
    
    // Check if we're returning from review-site-details
    if (req.query.returnTo === 'review-site-details') {
        req.session.data['fromReviewSiteDetails'] = 'true';
    }
    
    res.render(version + section + 'manual-entry/site-width');
});

// Site width - POST route
router.post('/' + version + section + 'manual-entry/site-width-router', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";

    const width = req.session.data['manual-site-width'];
    const returnTo = req.query.returnTo;

    // Only check if data is entered (for prototype purposes)
    if (!width || width.trim() === "") {
        req.session.data['errorthispage'] = "true";
        req.session.data['errortypeone'] = "true";
        res.redirect('site-width' + (returnTo ? '?returnTo=' + returnTo : ''));
        return;
    }

    // Clear error
    req.session.data['errorthispage'] = "false";
    req.session.data['errortypeone'] = "false";
    
    // Check if we're coming from review-site-details page
    if (req.session.data['fromReviewSiteDetails'] === 'true') {
        delete req.session.data['fromReviewSiteDetails']; // Clear the flag
        return res.redirect('review-site-details');
    }

    res.redirect('review-site-details');
});

// Review site details - GET route
router.get('/' + version + section + 'manual-entry/review-site-details', function (req, res) {
    req.session.data['errorthispage'] = "false";
    req.session.data['errors'] = [];
    
    res.render(version + section + 'manual-entry/review-site-details');
});

// Review site details - POST route
router.post('/' + version + section + 'manual-entry/review-site-details-router', function (req, res) {
    // Mark the task as completed
    req.session.data['exempt-information-3-status'] = 'completed';
    
    // Redirect to task list or next step
    res.redirect('../task-list');
});

} 